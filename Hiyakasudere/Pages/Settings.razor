@page "/settings"
@using Hiyakasudere.Data.Internal.Config
@using Hiyakasudere.Data.Internal.MultiplatformInterfaces
@using Hiyakasudere.Data.Internal.Data.Post
@using Blazored.Typeahead
@inject IAppConfigService _appConfig;
@inject IPostTranslationService _postService;
@inject IFileManager _fileManager;

<h1>Settings</h1>

<hr>

@if(configDataModel != null)
{
    <EditForm Model="@configDataModel" OnValidSubmit="@HandleValidSubmit">
        <p>
            <label>
                NSFW Enabler:
                <InputCheckbox @bind-Value="configDataModel.NSFWEnabled"></InputCheckbox>
            </label>
        </p>
        <p>
            <label>
                Tag blacklist:
                <BlazoredTypeahead SearchMethod="GetMatchingTags" @bind-Values="SelectedBlacklistedTags" MinimumLength="2">
                    <SelectedTemplate Context="BLTag">
                        @BLTag.Name
                    </SelectedTemplate>
                    <HelpTemplate>
                        Please enter a minimum of 2 characters to perform a search.
                    </HelpTemplate>
                    <ResultTemplate Context="BLTag">
                        @BLTag.Name
                    </ResultTemplate>
                </BlazoredTypeahead>
            </label>
        </p>
        <p>
            <label>
                Source select:
                <InputSelect @bind-Value="configDataModel.SelectedSource">
                    <option value="1">Yandere</option>
                    <option value="2">Safebooru</option>
                    <option value="3">Kona-chan</option>
                </InputSelect>
            </label>
        </p>
        <p>
            <label>
                Displayed posts:
                <InputSelect @bind-Value="configDataModel.PostsPerPage">
                    <option value="12">12</option>
                    <option value="18">18</option>
                    <option value="24">24</option>
                    <option value="48">48</option>
                </InputSelect>
            </label>
        </p>
        <p>
            <button type="submit" class="btn btn-primary">Save settings</button>
        </p>
    </EditForm>

    <input class="btn btn-primary" value="Open Images Directory" @onclick="OpenSaveDir">
}


@code {

    private ConfigDataModel configDataModel;
    private IList<TagInternal>? SelectedBlacklistedTags;

    protected async Task<IEnumerable<TagInternal>> GetMatchingTags(string searchText)
    {
        return await _postService.TryAutocompleteTag(searchText);
    }

    protected override void OnInitialized()
    {
        configDataModel = _appConfig.GetCurrentConfiguration();
        SelectedBlacklistedTags = configDataModel.BlackListedTags;
    }

    private void HandleValidSubmit()
    {
        _appConfig.UpdateConfig(configDataModel.SelectedSource, configDataModel.PostsPerPage, configDataModel.NSFWEnabled, SelectedBlacklistedTags.ToList());
    }

    private void OpenSaveDir()
    {
        _fileManager.OpenImagesDir();
    }
}
